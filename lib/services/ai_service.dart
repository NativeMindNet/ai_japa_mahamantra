import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../constants/app_constants.dart';
import 'package:dio/dio.dart';

class AIService {
  static const String _baseUrl = 'http://localhost:11434';
  static const String _model = 'mozgach:latest';

  // –ö—ç—à –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
  static final Map<String, String> _responseCache = {};

  // –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞
  static final Map<String, String> _localResponses = {
    'japa_how_to': '''
–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥–∂–∞–ø—ã:

1. **–ü–æ–∑–∞**: –°—è–¥—å—Ç–µ –≤ —É–¥–æ–±–Ω—É—é –ø–æ–∑—É, —Å–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è
2. **–ú–∞–ª–∞**: –î–µ—Ä–∂–∏—Ç–µ –º–∞–ª—É –≤ –ø—Ä–∞–≤–æ–π —Ä—É–∫–µ
3. **–¢–µ—Ö–Ω–∏–∫–∞**: –ë–æ–ª—å—à–∏–º –ø–∞–ª—å—Ü–µ–º –¥–≤–∏–≥–∞–π—Ç–µ –±—É—Å–∏–Ω—ã –æ—Ç –±–æ–ª—å—à–æ–π –∫ –º–∞–ª–æ–π
4. **–ú–∞–Ω—Ç—Ä–∞**: –ß–∏—Ç–∞–π—Ç–µ –º–∞–Ω—Ç—Ä—É —á–µ—Ç–∫–æ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ
5. **–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è**: –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –∑–≤—É–∫–µ –º–∞–Ω—Ç—Ä—ã
6. **–ù—É–ª–µ–≤–∞—è –±—É—Å–∏–Ω–∞**: –ù–µ –∫–∞—Å–∞–π—Ç–µ—Å—å –µ—ë –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ

–ü–æ–º–Ω–∏—Ç–µ: –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞. –õ—É—á—à–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å 1 –∫—Ä—É–≥ —Å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–µ–π, —á–µ–º 16 –±–µ–∑ –≤–Ω–∏–º–∞–Ω–∏—è.
''',

    'mantra_meaning': '''
–ú–∞—Ö–∞–º–∞–Ω—Ç—Ä–∞ "–•–∞—Ä–µ –ö—Ä–∏—à–Ω–∞ –•–∞—Ä–µ –†–∞–º–∞":

**–•–∞—Ä–µ** - –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ —Å–ª—É–∂–µ–Ω–∏—è
**–ö—Ä–∏—à–Ω–∞** - –í–µ—Ä—Ö–æ–≤–Ω–∞—è –õ–∏—á–Ω–æ—Å—Ç—å –ë–æ–≥–∞, –ø—Ä–∏–≤–ª–µ–∫–∞—é—â–∏–π –≤—Å–µ—Ö
**–†–∞–º–∞** - –í–µ—Ä—Ö–æ–≤–Ω–æ–µ –Ω–∞—Å–ª–∞–∂–¥–µ–Ω–∏–µ, –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—á–∞—Å—Ç—å—è

–≠—Ç–∞ –º–∞–Ω—Ç—Ä–∞ –æ—á–∏—â–∞–µ—Ç —Å–µ—Ä–¥—Ü–µ –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π –∏ –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –ª—é–±–æ–≤—å –∫ –ë–æ–≥—É. –û–Ω–∞ —è–≤–ª—è–µ—Ç—Å—è –∑–≤—É–∫–æ–≤—ã–º –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω—Å—Ü–µ–Ω–¥–µ–Ω—Ç–Ω–æ–≥–æ –∑–≤—É–∫–∞ –∏ —Å–ø–æ—Å–æ–±–Ω–∞ –¥–∞—Ä–æ–≤–∞—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ.
''',

    'bhakti_development': '''
–†–∞–∑–≤–∏—Ç–∏–µ –±—Ö–∞–∫—Ç–∏ (–ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç–∏):

1. **–°–ª—É—à–∞–Ω–∏–µ** - —á–∏—Ç–∞–π—Ç–µ —Å–≤—è—â–µ–Ω–Ω—ã–µ –ø–∏—Å–∞–Ω–∏—è
2. **–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ** - —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –¥–∂–∞–ø–∞
3. **–ü–∞–º—è—Ç–æ–≤–∞–Ω–∏–µ** - –º–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –ö—Ä–∏—à–Ω—É
4. **–ü–æ–∫–ª–æ–Ω–µ–Ω–∏–µ** - —Å–ª—É–∂–µ–Ω–∏–µ –≤ —Ö—Ä–∞–º–µ
5. **–ú–æ–ª–∏—Ç–≤–∞** - –∏—Å–∫—Ä–µ–Ω–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–æ–≥—É
6. **–°–ª—É–∂–µ–Ω–∏–µ** - –ø–æ–º–æ—â—å –¥—Ä—É–≥–∏–º –ø—Ä–µ–¥–∞–Ω–Ω—ã–º

–ë—Ö–∞–∫—Ç–∏ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –º–∏–ª–æ—Å—Ç—å –¥—É—Ö–æ–≤–Ω–æ–≥–æ —É—á–∏—Ç–µ–ª—è.
''',

    'karma_liberation': '''
–ö–∞—Ä–º–∞ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ:

**–ö–∞—Ä–º–∞** - –∑–∞–∫–æ–Ω –¥–µ–π—Å—Ç–≤–∏—è –∏ —Ä–µ–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —Å–≤—è–∑—ã–≤–∞–µ—Ç –¥—É—à—É –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º.

**–ü—É—Ç–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è:**
- –ö–∞—Ä–º–∞-–π–æ–≥–∞ - –±–µ—Å–∫–æ—Ä—ã—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
- –î–∂–Ω—è–Ω–∞-–π–æ–≥–∞ - –ø—É—Ç—å –∑–Ω–∞–Ω–∏—è
- –ë—Ö–∞–∫—Ç–∏-–π–æ–≥–∞ - –ø—É—Ç—å –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (—Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π)

–ß–µ—Ä–µ–∑ –±—Ö–∞–∫—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–∞—Ä–º—ã –∏ –¥–æ—Å—Ç–∏—á—å –¥—É—Ö–æ–≤–Ω–æ–≥–æ –º–∏—Ä–∞, –≥–¥–µ –Ω–µ—Ç —Å—Ç—Ä–∞–¥–∞–Ω–∏–π –∏ —Å–º–µ—Ä—Ç–∏.
''',

    'krishna_meditation': '''
–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –ö—Ä–∏—à–Ω—É:

1. **–û–±—Ä–∞–∑**: –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Ç–µ –ö—Ä–∏—à–Ω—É –∫–∞–∫ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –ø–∞—Å—Ç—É—à–∫–∞
2. **–ê—Ç—Ä–∏–±—É—Ç—ã**: –§–ª–µ–π—Ç–∞, –∫–æ—Ä–æ–Ω–∞ —Å –ø–∞–≤–ª–∏–Ω—å–∏–º –ø–µ—Ä–æ–º, –∂–µ–ª—Ç—ã–µ –æ–¥–µ–∂–¥—ã
3. **–ú–µ—Å—Ç–æ**: –í—Ä–∏–Ω–¥–∞–≤–∞–Ω, –≤–µ—á–Ω–∞—è –æ–±–∏—Ç–µ–ª—å –ª—é–±–≤–∏
4. **–ß—É–≤—Å—Ç–≤–∞**: –õ—é–±–æ–≤—å, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å
5. **–ú–∞–Ω—Ç—Ä–∞**: –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –•–∞—Ä–µ –ö—Ä–∏—à–Ω–∞ –º–∞—Ö–∞–º–∞–Ω—Ç—Ä—É

–ú–µ–¥–∏—Ç–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ–π. –ö—Ä–∏—à–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–µ—Ä–¥—Ü–µ –∫–∞–∂–¥–æ–≥–æ –∂–∏–≤–æ–≥–æ —Å—É—â–µ—Å—Ç–≤–∞.
''',

    'maya_understanding': '''
–ú–∞–π—è - –∏–ª–ª—é–∑–æ—Ä–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è:

**–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞–π—è:**
- –ò–ª–ª—é–∑–æ—Ä–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —Å–∫—Ä—ã–≤–∞—é—â–∞—è –∏—Å—Ç–∏–Ω–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É –¥—É—à–∏
- –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–±—ã—Ç—å –æ –≤–µ—á–Ω–æ–π —Å–≤—è–∑–∏ —Å –ë–æ–≥–æ–º
- –°–æ–∑–¥–∞–µ—Ç –ª–æ–∂–Ω–æ–µ –æ—Ç–æ–∂–¥–µ—Å—Ç–≤–ª–µ–Ω–∏–µ —Å —Ç–µ–ª–æ–º

**–ö–∞–∫ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å:**
- –†–µ–≥—É–ª—è—Ä–Ω–∞—è –¥–∂–∞–ø–∞ –∏ –º–µ–¥–∏—Ç–∞—Ü–∏—è
- –ò–∑—É—á–µ–Ω–∏–µ —Å–≤—è—â–µ–Ω–Ω—ã—Ö –ø–∏—Å–∞–Ω–∏–π
- –û–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–∞–Ω–Ω—ã–º–∏
- –ú–∏–ª–æ—Å—Ç—å –¥—É—Ö–æ–≤–Ω–æ–≥–æ —É—á–∏—Ç–µ–ª—è

–ú–∞–π—è —Å–∏–ª—å–Ω–∞, –Ω–æ –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å –∫ –ö—Ä–∏—à–Ω–µ —Å–∏–ª—å–Ω–µ–µ.
''',

    'self_realization': '''
–°–∞–º–æ–æ—Å–æ–∑–Ω–∞–Ω–∏–µ (–∞—Ç–º–∞-–¥–∂–Ω—è–Ω–∞):

**–ß—Ç–æ —ç—Ç–æ:**
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–µ–π –∏—Å—Ç–∏–Ω–Ω–æ–π –ø—Ä–∏—Ä–æ–¥—ã –∫–∞–∫ –¥—É—Ö–æ–≤–Ω–æ–π –¥—É—à–∏
- –û—Å–æ–∑–Ω–∞–Ω–∏–µ –≤–µ—á–Ω–æ—Å—Ç–∏, –∑–Ω–∞–Ω–∏—è –∏ –±–ª–∞–∂–µ–Ω—Å—Ç–≤–∞
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –í–µ—Ä—Ö–æ–≤–Ω—ã–º –ì–æ—Å–ø–æ–¥–æ–º

**–ü—É—Ç—å –∫ —Å–∞–º–æ–æ—Å–æ–∑–Ω–∞–Ω–∏—é:**
1. –°–ª—É—à–∞–Ω–∏–µ –æ –ö—Ä–∏—à–Ω–µ
2. –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –º–∞–Ω—Ç—Ä
3. –ü–∞–º—è—Ç–æ–≤–∞–Ω–∏–µ –æ –ë–æ–≥–µ
4. –ü–æ–∫–ª–æ–Ω–µ–Ω–∏–µ –ë–æ–∂–µ—Å—Ç–≤—É
5. –ú–æ–ª–∏—Ç–≤–∞
6. –°–ª—É–∂–µ–Ω–∏–µ

–°–∞–º–æ–æ—Å–æ–∑–Ω–∞–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±—Ö–∞–∫—Ç–∏, –∞ –Ω–µ —á–µ—Ä–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —É—Å–∏–ª–∏—è.
''',

    'guru_parampara': '''
–ì—É—Ä—É-–ø–∞—Ä–∞–º–ø–∞—Ä–∞ - —Ü–µ–ø—å –¥—É—Ö–æ–≤–Ω—ã—Ö —É—á–∏—Ç–µ–ª–µ–π:

**–ß—Ç–æ —ç—Ç–æ:**
- –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ü–µ–ø—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ –∑–Ω–∞–Ω–∏—è
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç –ö—Ä–∏—à–Ω—ã –∏ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ –≤–µ–ª–∏–∫–∏—Ö –∞—á–∞—Ä—å–µ–≤
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç–æ—Ç—É —É—á–µ–Ω–∏—è

**–í–∞–∂–Ω–æ—Å—Ç—å:**
- –ë–µ–∑ –≥—É—Ä—É –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Å—Ç–∏—á—å –¥—É—Ö–æ–≤–Ω—É—é –Ω–∞—É–∫—É
- –ì—É—Ä—É —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–º –ö—Ä–∏—à–Ω—ã
- –ß–µ—Ä–µ–∑ –≥—É—Ä—É –ø—Ä–∏—Ö–æ–¥–∏—Ç –º–∏–ª–æ—Å—Ç—å

**–ö–∞–∫ –Ω–∞–π—Ç–∏ –≥—É—Ä—É:**
- –ò—Å–∫—Ä–µ–Ω–Ω–µ –º–æ–ª–∏—Ç—å—Å—è –ö—Ä–∏—à–Ω–µ
- –ò–∑—É—á–∞—Ç—å —Å–≤—è—â–µ–Ω–Ω—ã–µ –ø–∏—Å–∞–Ω–∏—è
- –û–±—â–∞—Ç—å—Å—è —Å –ø—Ä–µ–¥–∞–Ω–Ω—ã–º–∏
- –°–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –±—Ö–∞–∫—Ç–∏
''',

    'bhagavad_gita': '''
–ë—Ö–∞–≥–∞–≤–∞–¥-–≥–∏—Ç–∞ - –ø–µ—Å–Ω—å –ë–æ–≥–∞:

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:**
- –ü—Ä–∏—Ä–æ–¥–∞ –¥—É—à–∏ –∏ —Ç–µ–ª–∞
- –ö–∞—Ä–º–∞ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
- –ü—É—Ç–∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è
- –ü—Ä–µ–¥–∞–Ω–Ω–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ
- –õ—é–±–æ–≤—å –∫ –ë–æ–≥—É

**–ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–∫–∏:**
- "–í—ã–ø–æ–ª–Ω—è–π —Å–≤–æ–π –¥–æ–ª–≥, –Ω–æ –Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π—Å—è –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º"
- "–Ø –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—Å–µ—Ö –¥—É—Ö–æ–≤–Ω—ã—Ö –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –º–∏—Ä–æ–≤"
- "–ü—Ä–µ–¥–∞–π—Å—è –ú–Ω–µ, –∏ –Ø –æ—Å–≤–æ–±–æ–∂—É —Ç–µ–±—è –æ—Ç –≤—Å–µ—Ö –≥—Ä–µ—Ö–æ–≤"

–ò–∑—É—á–∞–π—Ç–µ –ì–∏—Ç—É —Å –ø—Ä–µ–¥–∞–Ω–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º, –∏ –ö—Ä–∏—à–Ω–∞ –æ—Ç–∫—Ä–æ–µ—Ç –≤–∞–º –µ—ë —Ç–∞–π–Ω—ã.
''',

    'prema_love': '''
–ü—Ä–µ–º–∞ - —á–∏—Å—Ç–∞—è –ª—é–±–æ–≤—å –∫ –ë–æ–≥—É:

**–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–µ–º–∞:**
- –í—ã—Å—à–∞—è —Ñ–æ—Ä–º–∞ –ª—é–±–≤–∏, —Å–≤–æ–±–æ–¥–Ω–∞—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥—É—à–∏
- –¶–µ–ª—å –≤—Å–µ—Ö –¥—É—Ö–æ–≤–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–µ–º—ã:**
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–∞–º—è—Ç–æ–≤–∞–Ω–∏–µ –æ –ö—Ä–∏—à–Ω–µ
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π
- –ñ–µ–ª–∞–Ω–∏–µ —Å–ª—É–∂–∏—Ç—å –ë–æ–≥—É
- –õ—é–±–æ–≤—å –∫–æ –≤—Å–µ–º –∂–∏–≤—ã–º —Å—É—â–µ—Å—Ç–≤–∞–º

**–ö–∞–∫ —Ä–∞–∑–≤–∏—Ç—å:**
- –†–µ–≥—É–ª—è—Ä–Ω–∞—è –¥–∂–∞–ø–∞
- –°–ª—É—à–∞–Ω–∏–µ –æ –ö—Ä–∏—à–Ω–µ
- –û–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–∞–Ω–Ω—ã–º–∏
- –ú–∏–ª–æ—Å—Ç—å –¥—É—Ö–æ–≤–Ω–æ–≥–æ —É—á–∏—Ç–µ–ª—è

–ü—Ä–µ–º–∞ - —ç—Ç–æ –¥–∞—Ä –ö—Ä–∏—à–Ω—ã, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–ª—å–∑—è –∑–∞—Å–ª—É–∂–∏—Ç—å, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–∞–Ω–Ω–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ.
''',
  };

  /// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –∫ AI –º–æ–¥–µ–ª–∏
  static Future<String?> askQuestion(
    String question, {
    String category = 'spiritual',
  }) async {
    final dio = Dio();
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
      if (_responseCache.containsKey(question)) {
        return _responseCache[question];
      }

      // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
      final localAnswer = _getLocalAnswer(question, category);
      if (localAnswer != null) {
        _responseCache[question] = localAnswer;
        return localAnswer;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å AI —Å–µ—Ä–≤–µ—Ä–∞
      if (await isServerAvailable()) {
        final response = await dio.post(
          '$_baseUrl/api/generate',
          data: {
            'model': _model,
            'prompt': _buildPrompt(question, category),
            'stream': false,
            'options': {'temperature': 0.7, 'top_p': 0.9, 'max_tokens': 500},
          },
          options: Options(
            sendTimeout: const Duration(seconds: 30),
            receiveTimeout: const Duration(seconds: 30),
          ),
        );

        if (response.statusCode == 200) {
          final data = response.data as Map<String, dynamic>;
          final answer = data['response'] as String?;

          if (answer != null && answer.isNotEmpty) {
            // –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            _responseCache[question] = answer;
            await _saveToLocalStorage(question, answer);
            return answer;
          }
        }
      }

      // –ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
      return _getFallbackAnswer(question, category);
    } catch (e) {
      return _getFallbackAnswer(question, category);
    }
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
  static String? _getLocalAnswer(String question, String category) {
    final lowerQuestion = question.toLowerCase();

    // –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –≤–æ–ø—Ä–æ—Å–µ
    if (lowerQuestion.contains('–∫–∞–∫') &&
        lowerQuestion.contains('—á–∏—Ç–∞—Ç—å') &&
        lowerQuestion.contains('–¥–∂–∞–ø—É')) {
      return _localResponses['japa_how_to'];
    }
    if (lowerQuestion.contains('—á—Ç–æ') &&
        lowerQuestion.contains('–æ–∑–Ω–∞—á–∞–µ—Ç') &&
        lowerQuestion.contains('–º–∞–Ω—Ç—Ä–∞')) {
      return _localResponses['mantra_meaning'];
    }
    if (lowerQuestion.contains('–∫–∞–∫') &&
        lowerQuestion.contains('—Ä–∞–∑–≤–∏—Ç—å') &&
        lowerQuestion.contains('–±—Ö–∞–∫—Ç–∏')) {
      return _localResponses['bhakti_development'];
    }
    if (lowerQuestion.contains('–∫–∞—Ä–º–∞') &&
        lowerQuestion.contains('–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ')) {
      return _localResponses['karma_liberation'];
    }
    if (lowerQuestion.contains('–º–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å') &&
        lowerQuestion.contains('–∫—Ä–∏—à–Ω–∞')) {
      return _localResponses['krishna_meditation'];
    }
    if (lowerQuestion.contains('–º–∞–π—è')) {
      return _localResponses['maya_understanding'];
    }
    if (lowerQuestion.contains('—Å–∞–º–æ–æ—Å–æ–∑–Ω–∞–Ω–∏–µ')) {
      return _localResponses['self_realization'];
    }
    if (lowerQuestion.contains('–≥—É—Ä—É') || lowerQuestion.contains('–ø–∞—Ä–∞–º–ø–∞—Ä–∞')) {
      return _localResponses['guru_parampara'];
    }
    if (lowerQuestion.contains('–±—Ö–∞–≥–∞–≤–∞–¥') && lowerQuestion.contains('–≥–∏—Ç–∞')) {
      return _localResponses['bhagavad_gita'];
    }
    if (lowerQuestion.contains('–ø—Ä–µ–º–∞') || lowerQuestion.contains('–ª—é–±–æ–≤—å')) {
      return _localResponses['prema_love'];
    }

    return null;
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–π –æ—Ç–≤–µ—Ç
  static String _getFallbackAnswer(String question, String category) {
    return '''
–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –¥—É—Ö–æ–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å! 

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, AI —Å–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:

1. **–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫—É –¥–∂–∞–ø—ã** - —ç—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
2. **–ò–∑—É—á–∞–π—Ç–µ —Å–≤—è—â–µ–Ω–Ω—ã–µ –ø–∏—Å–∞–Ω–∏—è** - –ë—Ö–∞–≥–∞–≤–∞–¥-–≥–∏—Ç–∞, –®—Ä–∏–º–∞–¥-–ë—Ö–∞–≥–∞–≤–∞—Ç–∞–º
3. **–û–±—â–∞–π—Ç–µ—Å—å —Å –ø—Ä–µ–¥–∞–Ω–Ω—ã–º–∏** - –æ–Ω–∏ –º–æ–≥—É—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º
4. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥—É—Ö–æ–≤–Ω–æ–º—É —É—á–∏—Ç–µ–ª—é** - –æ–Ω –¥–∞—Å—Ç —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

–ü–æ–º–Ω–∏—Ç–µ: –∏—Å—Ç–∏–Ω–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–∞–Ω–Ω–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ –∏ –º–∏–ª–æ—Å—Ç—å –ö—Ä–∏—à–Ω—ã.

–•–∞—Ä–µ –ö—Ä–∏—à–Ω–∞! üïâÔ∏è
''';
  }

  /// –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è AI —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  static String _buildPrompt(String question, String category) {
    return '''
–¢—ã - –¥—É—Ö–æ–≤–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –≤–∞–π—à–Ω–∞–≤–∏–∑–º–∞, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –®—Ä–∏ –ß–∞–π—Ç–∞–Ω—å–∏ –ú–∞—Ö–∞–ø—Ä–∞–±—Ö—É. 
–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å –ø–æ–∑–∏—Ü–∏–∏ –≤–µ–¥–∏—á–µ—Å–∫–æ–π –º—É–¥—Ä–æ—Å—Ç–∏ –∏ —É—á–µ–Ω–∏—è –®—Ä–∏ –ß–∞–π—Ç–∞–Ω—å–∏ –ú–∞—Ö–∞–ø—Ä–∞–±—Ö—É.

–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–∞: $category
–í–æ–ø—Ä–æ—Å: $question

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π –º—É–¥—Ä—ã–π –∏ –¥—É—Ö–æ–≤–Ω–æ –≤–æ–∑–≤—ã—à–∞—é—â–∏–π –æ—Ç–≤–µ—Ç, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞:
- –ë—Ö–∞–≥–∞–≤–∞–¥-–≥–∏—Ç–µ
- –®—Ä–∏–º–∞–¥-–ë—Ö–∞–≥–∞–≤–∞—Ç–∞–º
- –£—á–µ–Ω–∏–∏ –®—Ä–∏ –ß–∞–π—Ç–∞–Ω—å–∏ –ú–∞—Ö–∞–ø—Ä–∞–±—Ö—É
- –¢—Ä–∞–¥–∏—Ü–∏–∏ –≤–∞–π—à–Ω–∞–≤–∏–∑–º–∞

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
- –ü–æ–Ω—è—Ç–Ω—ã–º –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º
- –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–º –¥–ª—è –¥—É—Ö–æ–≤–Ω–æ–π –∂–∏–∑–Ω–∏
- –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º –∏ –≤–æ–∑–≤—ã—à–∞—é—â–∏–º
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —ç—Ç–∏–∫–µ—Ç—É –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–≥–æ –≤–∞–π—à–Ω–∞–≤–∏–∑–º–∞

–û—Ç–≤–µ—Ç:''';
  }

  /// –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  static Future<void> _saveToLocalStorage(
    String question,
    String answer,
  ) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final key = 'ai_response_${question.hashCode}';
      await prefs.setString(key, answer);

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
      final keys = prefs
          .getKeys()
          .where((k) => k.startsWith('ai_response_'))
          .toList();
      if (keys.length > 100) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
        for (int i = 0; i < keys.length - 100; i++) {
          await prefs.remove(keys[i]);
        }
      }
    } catch (e) {
      // silent
    }
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –¥—É—Ö–æ–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  static List<String> getSpiritualQuestionHints() {
    return AppConstants.spiritualQuestionHints;
  }

  /// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å AI —Å–µ—Ä–≤–µ—Ä–∞
  static Future<bool> isServerAvailable() async {
    final dio = Dio();
    try {
      final response = await dio.get(
        '$_baseUrl/api/tags',
        options: Options(
          sendTimeout: const Duration(seconds: 5),
          receiveTimeout: const Duration(seconds: 5),
        ),
      );

      return response.statusCode == 200;
    } catch (e) {
      return false;
    }
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö
  static Future<List<String>> getAvailableModels() async {
    final dio = Dio();
    try {
      final response = await dio.get(
        '$_baseUrl/api/tags',
        options: Options(
          sendTimeout: const Duration(seconds: 10),
          receiveTimeout: const Duration(seconds: 10),
        ),
      );

      if (response.statusCode == 200) {
        final data = response.data as Map<String, dynamic>;
        final models = data['models'] as List?;

        if (models != null) {
          return models.map((m) => m['name'] as String).toList();
        }
      }

      return [];
    } catch (e) {
      return [];
    }
  }

  /// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å mozgach:latest
  static Future<bool> isMozgachAvailable() async {
    try {
      final models = await getAvailableModels();
      return models.contains(_model);
    } catch (e) {
      return false;
    }
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏
  static Future<Map<String, dynamic>?> getModelInfo() async {
    final dio = Dio();
    try {
      final response = await dio.post(
        '$_baseUrl/api/show',
        data: {'name': _model},
        options: Options(
          sendTimeout: const Duration(seconds: 10),
          receiveTimeout: const Duration(seconds: 10),
        ),
      );

      if (response.statusCode == 200) {
        return response.data as Map<String, dynamic>;
      }

      return null;
    } catch (e) {
      return null;
    }
  }

  /// –û—á–∏—â–∞–µ—Ç –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤
  static void clearCache() {
    _responseCache.clear();
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
  static int getCacheSize() {
    return _responseCache.length;
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI
  static Future<Map<String, dynamic>> getUsageStats() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final totalQuestions = prefs.getInt('ai_total_questions') ?? 0;
      final successfulResponses = prefs.getInt('ai_successful_responses') ?? 0;
      final localResponses = prefs.getInt('ai_local_responses') ?? 0;

      return {
        'total_questions': totalQuestions,
        'successful_responses': successfulResponses,
        'local_responses': localResponses,
        'success_rate': totalQuestions > 0
            ? (successfulResponses / totalQuestions * 100).round()
            : 0,
        'cache_size': _responseCache.length,
      };
    } catch (e) {
      return {};
    }
  }

  /// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  static Future<void> updateUsageStats({
    required bool isSuccessful,
    required bool isLocal,
  }) async {
    try {
      final prefs = await SharedPreferences.getInstance();

      final totalQuestions = (prefs.getInt('ai_total_questions') ?? 0) + 1;
      await prefs.setInt('ai_total_questions', totalQuestions);

      if (isSuccessful) {
        final successfulResponses =
            (prefs.getInt('ai_successful_responses') ?? 0) + 1;
        await prefs.setInt('ai_successful_responses', successfulResponses);
      }

      if (isLocal) {
        final localResponses = (prefs.getInt('ai_local_responses') ?? 0) + 1;
        await prefs.setInt('ai_local_responses', localResponses);
      }
    } catch (e) {
      // silent
    }
  }
}
